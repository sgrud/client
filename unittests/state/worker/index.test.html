<!doctype html>
<meta charset="utf-8">

<script type="importmap">
  {
    "imports": {
      "@babel/runtime/helpers/": "/node_modules/@babel/runtime/helpers/esm/",
      "@sgrud/bus": "/node_modules/@sgrud/bus/index.modern.js",
      "@sgrud/core": "/node_modules/@sgrud/core/index.modern.js",
      "@sgrud/state": "/node_modules/@sgrud/state/index.modern.js",
      "comlink": "/node_modules/comlink/dist/esm/comlink.min.js",
      "rxjs": "/node_modules/rxjs/dist/esm5/index.js",
      "rxjs/ajax": "/node_modules/rxjs/dist/esm5/ajax/index.js",
      "tslib": "/node_modules/tslib/tslib.es6.js"
    }
  }
</script>

<script type="module">
  import { StateHandler, Store } from '@sgrud/state';
  import { from } from 'rxjs';

  const handler = new StateHandler();
  const state = { param: null };

  class Transient extends Store {
    static handle = 'sgrud.test.state.transient';
    async transiently(param) {
      return { ...this, param };
    }
  }

  class Universal extends Store {
    static handle = 'sgrud.test.state.universal';
    async universally(param) {
      return { ...this, param };
    }
  }

  class Versatile extends Store {
    static handle = 'sgrud.test.state.versatile';
    async versatilely(param) {
      await sgrud.state.effects.dispatch(
        'sgrud.test.state.transient',
        'transiently',
        [param]
      );

      await sgrud.state.effects.dispatch(
        'sgrud.test.state.universal',
        'universally',
        [param]
      );

      return (await sgrud.state.effects.fetch('/fetch')).json();
    }
  }

  handler.deploy(Transient.handle, Transient, state, !0).subscribe((store) => {
    window.transiently = (...action) => store.dispatch(...action).subscribe();
    from(store).subscribe((next) => window.transient = next);
  });

  handler.deploy(Universal.handle, Universal, state, !1).subscribe((store) => {
    window.universally = (...action) => store.dispatch(...action).subscribe();
    from(store).subscribe((next) => window.universal = next);
  });

  handler.deploy(Versatile.handle, Versatile, { }, true).subscribe((store) => {
    window.versatilely = (...action) => store.dispatch(...action).subscribe();
    from(store).subscribe((next) => window.versatile = next);
  });
</script>
